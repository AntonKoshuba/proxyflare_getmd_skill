# /// script
# dependencies = [
#   "httpx",
#   "trafilatura",
#   "proxyflare",
# ]
# ///

"""
–£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≤–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –∏—Ö –≤ —Ñ–æ—Ä–º–∞—Ç Markdown.

–í —Å–∫—Ä–∏–ø—Ç–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –ø–æ–¥—Ö–æ–¥ "–ï–¥–∏–Ω–æ–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏" (Single Responsibility Principle):
–∫–∞–∂–¥–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–≤–µ—á–∞–µ—Ç —Ä–æ–≤–Ω–æ –∑–∞ –æ–¥–Ω—É –∑–∞–¥–∞—á—É (—Å–∫–∞—á–∏–≤–∞–Ω–∏–µ, –ø–∞—Ä—Å–∏–Ω–≥, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ).
–≠—Ç–æ –¥–µ–ª–∞–µ—Ç –∫–æ–¥ —á–∏—Ç–∞–µ–º—ã–º, –ª–µ–≥–∫–æ —Ç–µ—Å—Ç–∏—Ä—É–µ–º—ã–º –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–º.

–û—Å–Ω–æ–≤–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:
1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ argparse –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –∏–∑ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏.
2. –ê–Ω–Ω–æ—Ç–∞—Ü–∏–∏ —Ç–∏–ø–æ–≤ –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç–∞ –≤ IDE.
3. –û—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–≤–º–µ—Å—Ç–æ –∂–µ—Å—Ç–∫–æ –∑–∞—à–∏—Ç—ã—Ö –∞–±—Å–æ–ª—é—Ç–Ω—ã—Ö –ø—É—Ç–µ–π).
4. –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –Ω–∞ —á–µ—Ç–∫–∏–µ —ç—Ç–∞–ø—ã (Fetch -> Extract -> Save).
"""

import argparse
import re
from datetime import datetime
from pathlib import Path

import httpx
import trafilatura

from proxyflare.client.manager import ProxyflareWorkersManager
from proxyflare.client.transport import ProxyflareTransport


def slugify(text: str) -> str:
    """
    –ü—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞ (slug).

    –£–±–∏—Ä–∞–µ—Ç –≤—Å–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã, –æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –¥–µ—Ñ–∏—Å—ã.
    –ü—Ä–æ–±–µ–ª—ã –∏ –∑–Ω–∞–∫–∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è –∑–∞–º–µ–Ω—è—é—Ç—Å—è –Ω–∞ –¥–µ—Ñ–∏—Å.

    Args:
        text: –ò—Å—Ö–æ–¥–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—å–∏).
    Returns:
        –°—Ç—Ä–æ–∫–∞, –ø—Ä–∏–≥–æ–¥–Ω–∞—è –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∫–∞—á–µ—Å—Ç–≤–µ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞.
    """
    text = text.lower()
    # –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –¥–µ—Ñ–∏—Å—ã
    text = re.sub(r"[^\w\s-]", "", text)
    # –ó–∞–º–µ–Ω—è–µ–º –ø—Ä–æ–±–µ–ª—ã –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏—è –Ω–∞ –æ–¥–∏–Ω–æ—á–Ω—ã–µ –¥–µ—Ñ–∏—Å—ã
    text = re.sub(r"[\s_-]+", "-", text).strip("-")
    return text


def fetch_html(url: str, proxy_config: str) -> str | None:
    """
    –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–µ—Ç–µ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞.
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç HTML —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –∏—Å–ø–æ–ª—å–∑—É—è Proxyflare –¥–ª—è –æ–±—Ö–æ–¥–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫.

    Args:
        url: –°—Å—ã–ª–∫–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è.
        proxy_config: –ü—É—Ç—å –∫ JSON –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤–æ—Ä–∫–µ—Ä–æ–≤ Proxyflare.

    Returns:
        HTML-–∫–æ–¥ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ –≤–∏–¥–µ —Å—Ç—Ä–æ–∫–∏, –∏–ª–∏ None –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏.
    """
    try:
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ø—Ä–æ–∫—Å–∏-–≤–æ—Ä–∫–µ—Ä–æ–≤
        manager = ProxyflareWorkersManager(source=proxy_config)
        transport = ProxyflareTransport(manager)
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–æ—Ä–∫–µ—Ä–æ–≤: {e}")
        return None

    # –ò–º–∏—Ç–∞—Ü–∏—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞, —á—Ç–æ–±—ã —Å–Ω–∏–∑–∏—Ç—å —Ä–∏—Å–∫ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    headers = {
        "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
        "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8",
        "Accept-Language": "ru-RU,ru;q=0.9,en-US;q=0.8,en;q=0.7",
    }

    print(f"üïµÔ∏è  –ó–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ Cloudflare: {url}")
    try:
        # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ httpx –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ç–µ–≤—ã–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏ —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–º
        with httpx.Client(
            transport=transport, timeout=25.0, follow_redirects=True, headers=headers
        ) as client:
            response = client.get(url)
            response.raise_for_status()
            return response.text
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã: {e}")
        return None


def extract_content(html: str) -> tuple[str, str | None]:
    """
    –ò–∑–≤–ª–µ–∫–∞–µ—Ç –ø–æ–ª–µ–∑–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é (–∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç) –∏–∑ "—Å—ã—Ä–æ–≥–æ" HTML.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫—É trafilatura –¥–ª—è —É–º–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏ —Ç–µ–∫—Å—Ç–∞ –æ—Ç —Ä–µ–∫–ª–∞–º—ã –∏ –º–µ–Ω—é.

    Args:
        html: –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ —Å—Ç—Ä–∞–Ω–∏—Ü—ã.

    Returns:
        –ö–æ—Ä—Ç–µ–∂ (–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç–∞—Ç—å–∏, Markdown –∫–æ–Ω—Ç–µ–Ω—Ç).
    """
    # –ü–æ–ø—ã—Ç–∫–∞ –∏–∑–≤–ª–µ—á—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–µ–≥ <title>)
    metadata = trafilatura.metadata.extract_metadata(html)

    # –†–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç: –µ—Å–ª–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è
    title = (
        metadata.title
        if metadata and metadata.title
        else f"article_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
    )

    # –ù–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–µ–π –≤ Markdown
    content = trafilatura.extract(
        html, include_comments=False, include_tables=True, output_format="markdown"
    )
    return title, content


def save_markdown(title: str, content: str, output_dir: Path) -> Path | None:
    """
    –û—Ç–≤–µ—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∑–∞ —Ä–∞–±–æ—Ç—É —Å —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π.
    –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç –≤ markdown —Ñ–∞–π–ª —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –∏–º–µ–Ω–µ–º.

    Args:
        title: –ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞.
        content: –¢–µ–∫—Å—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ Markdown.
        output_dir: –ü–∞–ø–∫–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (–±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞, –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç).

    Returns:
        –ü—É—Ç—å –∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–º—É —Ñ–∞–π–ª—É, –∏–ª–∏ None –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤–≤–æ–¥–∞-–≤—ã–≤–æ–¥–∞.
    """
    # –§–ª–∞–≥ parents=True —Å–æ–∑–¥–∞–µ—Ç –≤—Å—é —Ü–µ–ø–æ—á–∫—É –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π, exist_ok=True –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç –æ—à–∏–±–∫—É, –µ—Å–ª–∏ –ø–∞–ø–∫–∞ –µ—Å—Ç—å
    output_dir.mkdir(parents=True, exist_ok=True)

    file_name = f"{slugify(title)}.md"
    file_path = output_dir / file_name

    # –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö: –¥–æ–±–∞–≤–ª—è–µ–º timestamp, –µ—Å–ª–∏ —Ñ–∞–π–ª —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if file_path.exists():
        timestamp = datetime.now().strftime("%H%M%S")
        file_path = output_dir / f"{slugify(title)}_{timestamp}.md"

    try:
        file_path.write_text(content, encoding="utf-8")
        return file_path
    except OSError as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: {e}")
        return None


def main() -> None:
    """
    –ì–ª–∞–≤–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞.
    –û–±–µ—Ä—Ç–∫–∞ –Ω–∞–¥ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–æ–π –¥–ª—è —Ä–∞–∑–±–æ—Ä–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
    –∏ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏–∏ –≤—ã–∑–æ–≤–æ–≤ (Fetch -> Extract -> Save).
    """
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É–¥–æ–±–Ω–æ–≥–æ CLI (Command Line Interface)
    parser = argparse.ArgumentParser(
        description="–°–∫–∞—á–∏–≤–∞–µ—Ç —Å—Ç–∞—Ç—å—é –∏–∑ –≤–µ–±–∞ –∏ —á–∏—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –µ—ë –≤ —Ñ–æ—Ä–º–∞—Ç–µ Markdown."
    )

    # –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç
    parser.add_argument("url", help="URL —Å—Ç–∞—Ç—å–∏ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è")

    # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
    parser.add_argument(
        "-o",
        "--output",
        type=Path,
        default=Path("articles"),
        help="–ü–∞–ø–∫–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: ./articles)",
    )
    parser.add_argument(
        "-p",
        "--proxy-config",
        type=str,
        default="proxyflare-workers.json",
        help="–ü—É—Ç—å –∫ –∫–æ–Ω—Ñ–∏–≥—É Proxyflare (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: ./proxyflare-workers.json)",
    )

    args = parser.parse_args()

    # –®–∞–≥ 1. –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (—Å–µ—Ç—å)
    html = fetch_html(args.url, args.proxy_config)
    if not html:
        return

    # –®–∞–≥ 2. –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö (–æ—á–∏—Å—Ç–∫–∞ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
    title, content = extract_content(html)
    if not content:
        print("‚ö†Ô∏è  –ö–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —Å—Ç–∞—Ç—å—è —Å–ª–∏—à–∫–æ–º –º–∞–ª–∞.")
        return

    # –®–∞–≥ 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (—Ñ–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞)
    saved_path = save_markdown(title, content, args.output)
    if saved_path:
        print(f"‚úÖ –£—Å–ø–µ—à–Ω–æ! –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {saved_path}")


if __name__ == "__main__":
    main()
